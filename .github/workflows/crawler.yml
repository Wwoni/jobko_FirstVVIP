name: Crawl First VVIP
on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 1 * * 1'  # 매주 월요일 10:00 KST

defaults:
  run:
    shell: bash

jobs:
  run:
    runs-on: ubuntu-latest
    env:
         GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
         # 둘 중 하나만 설정하세요 ↓
         # 1) JSON 원문을 시크릿에 저장했다면:
         # GDRIVE_CREDENTIALS_DATA: ${{ secrets.GDRIVE_CREDENTIALS_JSON }}
         # 2) base64로 인코딩해 저장했다면:
         GDRIVE_CREDENTIALS_DATA: ${{ secrets.GDRIVE_CREDENTIALS_DATA_B64 }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # (크롬 사용 시)
      - uses: browser-actions/setup-chrome@v1

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ✅ base64 → 파일로 복구하고 경로를 환경변수로 노출
      - name: Decode service account to file
        run: |
          echo "${{ secrets.GDRIVE_CREDENTIALS_DATA_B64 }}" | base64 -d > credentials.json
          echo "GDRIVE_CREDENTIALS_PATH=$PWD/credentials.json" >> $GITHUB_ENV

      # (선택) 빠른 점검: 값 존재 여부만 출력 (내용은 출력 안 함)
      - name: Debug env
        run: |
          test -n "$GDRIVE_CREDENTIALS_PATH" && echo "CRED_PATH OK" || echo "CRED_PATH EMPTY"
          test -n "$GDRIVE_FOLDER_ID" && echo "FOLDER_ID length: ${#GDRIVE_FOLDER_ID}" || echo "FOLDER_ID EMPTY"

      - name: Write service account JSON to file
        run: |
          set -euo pipefail
          printf '%s' "${{ secrets.GDRIVE_CREDENTIALS_JSON }}" > credentials.json
          test -s credentials.json
          jq -e . credentials.json >/dev/null
          echo "GDRIVE_CREDENTIALS_PATH=$PWD/credentials.json" >> $GITHUB_ENV

      - name: Decode service account to file
        shell: bash
        run: |
          set -eu
          echo "${{ secrets.GDRIVE_CREDENTIALS_DATA_B64 }}" | base64 -d > credentials.json
          test -s credentials.json
          jq -e . credentials.json >/dev/null
          echo "GDRIVE_CREDENTIALS_PATH=$PWD/credentials.json" >> $GITHUB_ENV
      
      - name: Run crawler
        run: python jobko_FirstVVIP.py
